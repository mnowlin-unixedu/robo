<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROBOPOCALYPSE: Last March to Bunker 7</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#000;font-family:'Courier New',monospace}
canvas{display:block}
#blocker{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;cursor:pointer}
#blocker h1{font-size:42px;color:#ff2200;text-transform:uppercase;letter-spacing:8px;text-shadow:0 0 30px #ff2200,0 0 60px #ff0000;margin-bottom:10px;text-align:center}
#blocker h2{font-size:16px;color:#888;letter-spacing:4px;margin-bottom:40px}
.squad-intro{color:#aaa;font-size:13px;max-width:600px;text-align:center;line-height:1.8;margin-bottom:30px;padding:0 20px}
.squad-intro span{color:#ff6644;font-weight:bold}
.controls{color:#666;font-size:11px;margin-bottom:30px;text-align:center;line-height:2.2}
.controls b{color:#aaa}
.start-btn{padding:15px 50px;background:#ff2200;color:#000;font-size:18px;font-weight:bold;border:none;cursor:pointer;letter-spacing:4px;font-family:'Courier New',monospace;text-transform:uppercase}
.start-btn:hover{background:#ff4422;box-shadow:0 0 30px #ff2200}
#hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:50;display:none}
#health-bar{position:absolute;bottom:30px;left:30px;width:220px;height:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2)}
#health-fill{height:100%;width:100%;background:#ff2200;transition:width 0.3s}
#health-text{position:absolute;bottom:42px;left:30px;color:#ff2200;font-size:26px;font-weight:bold;text-shadow:0 0 10px rgba(255,0,0,0.5)}
#ammo-text{position:absolute;bottom:30px;right:30px;color:#fff;font-size:22px;text-align:right}
#weapon-name{position:absolute;bottom:56px;right:30px;color:#888;font-size:11px;letter-spacing:3px;text-transform:uppercase}
#crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px}
#crosshair::before,#crosshair::after{content:'';position:absolute;background:rgba(255,255,255,0.6)}
#crosshair::before{width:2px;height:20px;left:9px;top:0}
#crosshair::after{width:20px;height:2px;top:9px;left:0}
#zone-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:32px;letter-spacing:8px;text-transform:uppercase;opacity:0;transition:opacity 1s;text-shadow:0 0 20px rgba(255,255,255,0.5)}
#squad-status{position:absolute;top:20px;left:20px;display:flex;flex-direction:column;gap:6px}
.sq{display:flex;align-items:center;gap:8px;font-size:11px;color:#aaa;letter-spacing:1px}
.sq .dot{width:8px;height:8px;border-radius:50%;background:#00ff44;box-shadow:0 0 6px #00ff44}
.sq.down .dot{background:#ff0000;box-shadow:0 0 6px #ff0000}
.sq.down{color:#555;text-decoration:line-through}
#callout{position:absolute;top:35%;left:50%;transform:translateX(-50%);color:#ffaa00;font-size:15px;letter-spacing:2px;opacity:0;transition:opacity 0.5s;text-shadow:0 0 10px rgba(255,170,0,0.5);text-align:center;white-space:nowrap}
#damage-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at center,transparent 50%,rgba(255,0,0,0.4) 100%);opacity:0;transition:opacity 0.15s;pointer-events:none}
#victory-screen,#death-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:200}
#victory-screen h1{color:#00ff44;font-size:42px;letter-spacing:8px;text-shadow:0 0 30px #00ff44}
#death-screen h1{color:#ff2200;font-size:42px;letter-spacing:8px;text-shadow:0 0 30px #ff2200}
#victory-screen p,#death-screen p{color:#aaa;font-size:14px;margin-top:20px;max-width:500px;text-align:center}
.restart-btn{margin-top:30px;padding:12px 40px;background:#ff2200;color:#000;font-size:14px;font-weight:bold;border:none;cursor:pointer;letter-spacing:3px;font-family:'Courier New',monospace;pointer-events:auto}
#kill-count{position:absolute;top:20px;right:20px;color:#ff4444;font-size:13px;letter-spacing:2px}
#zone-progress{position:absolute;top:42px;right:20px;color:#666;font-size:11px;letter-spacing:1px}
</style>
</head>
<body>
<div id="blocker">
  <h1>Robopocalypse</h1>
  <h2>Last March to Bunker 7</h2>
  <div class="squad-intro">
    The machines have risen. Cities are burning. Your squad is all that's left.<br><br>
    <span>YOU</span> — Point man. Lead the way.<br>
    <span>REESE</span> — Heavy weapons. Walks like a tank.<br>
    <span>KIM</span> — Engineer. Spots drones before anyone.<br>
    <span>DAVIS</span> — Old soldier. Keeps the group moving.<br>
    <span>TORRES</span> — Youngest. Carries the supplies.<br><br>
    Fight through the forest, cross the snowfields, reach <span>Bunker 7</span>.<br>
    Not everyone will make it.
  </div>
  <div class="controls">
    <b>WASD</b> Move | <b>MOUSE</b> Aim | <b>CLICK</b> Fire | <b>R</b> Reload<br>
    <b>1</b> Rifle | <b>2</b> Shotgun | <b>3</b> Flamethrower | <b>SHIFT</b> Sprint
  </div>
  <button class="start-btn" id="startBtn">ENTER THE WARZONE</button>
</div>
<div id="hud">
  <div id="crosshair"></div>
  <div id="health-text">100</div>
  <div id="health-bar"><div id="health-fill"></div></div>
  <div id="weapon-name">ASSAULT RIFLE</div>
  <div id="ammo-text">30 / 150</div>
  <div id="squad-status"></div>
  <div id="zone-text"></div>
  <div id="callout"></div>
  <div id="damage-overlay"></div>
  <div id="kill-count">KILLS: 0</div>
  <div id="zone-progress"></div>
</div>
<div id="victory-screen">
  <h1>BUNKER 7 REACHED</h1>
  <p id="victory-msg"></p>
  <button class="restart-btn" onclick="location.reload()">PLAY AGAIN</button>
</div>
<div id="death-screen">
  <h1>KIA</h1>
  <p>The machines won this round.</p>
  <button class="restart-btn" onclick="location.reload()">TRY AGAIN</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
(function(){
'use strict';

var audioCtx=null,scene,camera,renderer,clock;
var playerPos=new THREE.Vector3(0,1.7,0),playerHealth=100;
var pitch=0,yaw=0,keys={},mouseDown=false,locked=false;
var gameActive=false,gameWon=false,kills=0,initialized=false;

var weapons={
  rifle:{name:'ASSAULT RIFLE',ammo:30,maxAmmo:30,reserve:150,fireRate:0.1,damage:18,spread:0.02,pellets:1,auto:true,snd:'rifle'},
  shotgun:{name:'SHOTGUN',ammo:8,maxAmmo:8,reserve:40,fireRate:0.55,damage:14,spread:0.09,pellets:6,auto:false,snd:'shotgun'},
  flamethrower:{name:'FLAMETHROWER',ammo:100,maxAmmo:100,reserve:200,fireRate:0.05,damage:5,range:14,pellets:0,auto:true,snd:'flame'}
};
var curWeap='rifle',lastFire=0,isReloading=false,reloadTimer=0;

var squad=[
  {name:'REESE',color:0x4488ff,hp:120,maxHp:120,alive:true,fr:0.45,dmg:22},
  {name:'KIM',color:0xff44aa,hp:80,maxHp:80,alive:true,fr:0.25,dmg:14},
  {name:'DAVIS',color:0xffaa44,hp:100,maxHp:100,alive:true,fr:0.6,dmg:20},
  {name:'TORRES',color:0x44ffaa,hp:70,maxHp:70,alive:true,fr:0.2,dmg:10}
];
var squadMeshes=[],enemies=[],particles=[],fireLights=[],snowPts=null;

var ZL=200,TL=600,curZone=0,spawnTmr=3,callTmr=0,MAX_EN=20;

var shouts={
  drone:['Drone above!','Eyes up! Drone!','Watch the sky!'],
  stumper:['Stumpers incoming!','Ground contacts!','Crawlers on us!'],
  heavy:['Heavy bot! Focus fire!','Tank unit!','Big one coming!'],
  down:['Man down!','We lost one!','Damn it... keep going!'],
  zone1:['Into the snow... stay tight.','Open ground. Less cover.'],
  zone2:['There it is. Bunker 7.','Final stretch! Move!'],
  general:['Keep moving!','Stay together!','Push forward!','Watch your sectors!']
};

function shout(cat){
  if(callTmr>0)return;var list=shouts[cat];if(!list)return;
  var txt=list[Math.floor(Math.random()*list.length)];
  var alv=squad.filter(function(s){return s.alive});
  var sp=alv.length?alv[Math.floor(Math.random()*alv.length)]:null;
  var el=document.getElementById('callout');
  el.textContent=sp?(sp.name+': "'+txt+'"'):txt;
  el.style.opacity='1';callTmr=3.5;
  setTimeout(function(){el.style.opacity='0'},3000);
}

function zoneText(t){
  var el=document.getElementById('zone-text');el.textContent=t;el.style.opacity='1';
  setTimeout(function(){el.style.opacity='0'},3000);
}

function updSquadHUD(){
  document.getElementById('squad-status').innerHTML=squad.map(function(s){
    return '<div class="sq '+(s.alive?'':'down')+'"><div class="dot"></div>'+s.name+'</div>';
  }).join('');
}

function updAmmo(){
  var w=weapons[curWeap];
  document.getElementById('ammo-text').textContent=w.ammo+' / '+w.reserve;
  if(!isReloading)document.getElementById('weapon-name').textContent=w.name;
}

// AUDIO
function initAudio(){try{audioCtx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}}

function snd(type,vol){
  if(!audioCtx)return;vol=vol||0.2;
  try{
    var now=audioCtx.currentTime;
    if(type==='rifle'||type==='shotgun'){
      var dur=type==='shotgun'?0.12:0.06;
      var buf=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*dur),audioCtx.sampleRate);
      var d=buf.getChannelData(0);
      for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5);
      var src=audioCtx.createBufferSource();src.buffer=buf;
      var g=audioCtx.createGain();
      g.gain.setValueAtTime(vol*(type==='shotgun'?2:1.2),now);
      g.gain.exponentialRampToValueAtTime(0.001,now+dur);
      src.connect(g);g.connect(audioCtx.destination);src.start(now);
    }else if(type==='flame'){
      var buf=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*0.08),audioCtx.sampleRate);
      var d=buf.getChannelData(0);
      for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*0.3*(1-i/d.length);
      var src=audioCtx.createBufferSource();src.buffer=buf;
      var g=audioCtx.createGain();g.gain.value=vol*0.5;
      src.connect(g);g.connect(audioCtx.destination);src.start(now);
    }else if(type==='explosion'){
      var buf=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*0.35),audioCtx.sampleRate);
      var d=buf.getChannelData(0);
      for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,0.7)*1.5;
      var src=audioCtx.createBufferSource();src.buffer=buf;
      var g=audioCtx.createGain();
      g.gain.setValueAtTime(vol*2,now);g.gain.exponentialRampToValueAtTime(0.001,now+0.35);
      src.connect(g);g.connect(audioCtx.destination);src.start(now);
    }else if(type==='hit'){
      var o=audioCtx.createOscillator();o.type='square';o.frequency.value=900;
      var g=audioCtx.createGain();g.gain.setValueAtTime(vol*0.3,now);
      g.gain.exponentialRampToValueAtTime(0.001,now+0.03);
      o.connect(g);g.connect(audioCtx.destination);o.start(now);o.stop(now+0.03);
    }else if(type==='robot_die'){
      var o=audioCtx.createOscillator();o.type='square';
      o.frequency.setValueAtTime(500,now);o.frequency.exponentialRampToValueAtTime(40,now+0.25);
      var g=audioCtx.createGain();g.gain.setValueAtTime(vol,now);
      g.gain.exponentialRampToValueAtTime(0.001,now+0.25);
      o.connect(g);g.connect(audioCtx.destination);o.start(now);o.stop(now+0.25);
    }else if(type==='damage'){
      var o=audioCtx.createOscillator();o.type='sawtooth';
      o.frequency.setValueAtTime(250,now);o.frequency.exponentialRampToValueAtTime(80,now+0.1);
      var g=audioCtx.createGain();g.gain.setValueAtTime(vol*0.7,now);
      g.gain.exponentialRampToValueAtTime(0.001,now+0.1);
      o.connect(g);g.connect(audioCtx.destination);o.start(now);o.stop(now+0.1);
    }
  }catch(e){}
}

// INIT
function init(){
  initAudio();
  clock=new THREE.Clock();
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x1a1a2e);
  scene.fog=new THREE.FogExp2(0x1a1a2e,0.005);

  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,400);
  camera.position.copy(playerPos);

  renderer=new THREE.WebGLRenderer({antialias:false});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5));
  renderer.toneMapping=THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure=1.2;
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0x667788,0.9));
  var dl=new THREE.DirectionalLight(0xffeedd,0.6);dl.position.set(50,80,30);scene.add(dl);
  var dl2=new THREE.DirectionalLight(0xff8866,0.3);dl2.position.set(-30,50,-20);scene.add(dl2);

  buildWorld();
  buildSquad();
  updSquadHUD();

  window.addEventListener('resize',function(){
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
  document.addEventListener('keydown',function(e){
    keys[e.code]=true;
    if(e.code==='Digit1'){curWeap='rifle';isReloading=false;updAmmo()}
    if(e.code==='Digit2'){curWeap='shotgun';isReloading=false;updAmmo()}
    if(e.code==='Digit3'){curWeap='flamethrower';isReloading=false;updAmmo()}
    if(e.code==='KeyR')startReload();
  });
  document.addEventListener('keyup',function(e){keys[e.code]=false});
  document.addEventListener('mousedown',function(e){if(e.button===0)mouseDown=true});
  document.addEventListener('mouseup',function(e){if(e.button===0)mouseDown=false});
  document.addEventListener('mousemove',function(e){
    if(!locked)return;
    yaw-=e.movementX*0.002;
    pitch-=e.movementY*0.002;
    pitch=Math.max(-1.4,Math.min(1.4,pitch));
  });
  document.addEventListener('pointerlockchange',function(){
    locked=(document.pointerLockElement===renderer.domElement);
    if(!locked&&gameActive&&!gameWon){
      document.getElementById('blocker').style.display='flex';
      document.querySelector('#blocker h2').textContent='PAUSED — CLICK TO RESUME';
      document.getElementById('startBtn').textContent='RESUME';
    }
  });

  document.getElementById('hud').style.display='block';
  gameActive=true;initialized=true;
  updAmmo();
  zoneText('THE FOREST');
  setTimeout(function(){shout('general')},2000);
  renderer.domElement.requestPointerLock();
  animate();
}

// WORLD
function buildWorld(){
  var geo=new THREE.PlaneGeometry(80,ZL);
  var g1=new THREE.Mesh(geo.clone(),new THREE.MeshBasicMaterial({color:0x1a3310}));
  g1.rotation.x=-Math.PI/2;g1.position.set(0,-0.01,-ZL/2);scene.add(g1);
  var g2=new THREE.Mesh(geo.clone(),new THREE.MeshBasicMaterial({color:0x667788}));
  g2.rotation.x=-Math.PI/2;g2.position.set(0,-0.01,-ZL*1.5);scene.add(g2);
  var g3=new THREE.Mesh(geo.clone(),new THREE.MeshBasicMaterial({color:0x333338}));
  g3.rotation.x=-Math.PI/2;g3.position.set(0,-0.01,-ZL*2.5);scene.add(g3);

  // FOREST
  var tMat=new THREE.MeshBasicMaterial({color:0x5c4033});
  var lMat=new THREE.MeshBasicMaterial({color:0x2d6a1e});
  var dlMat=new THREE.MeshBasicMaterial({color:0x5a4530});
  for(var i=0;i<90;i++){
    var x=(Math.random()-0.5)*70,z=-Math.random()*ZL;
    if(Math.abs(x)<6)continue;
    var h=4+Math.random()*5;
    var trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.35,h,5),tMat);
    trunk.position.set(x,h/2,z);scene.add(trunk);
    var ls=1.5+Math.random()*2.5;
    var leaf=new THREE.Mesh(new THREE.SphereGeometry(ls,5,4),Math.random()>0.3?lMat:dlMat);
    leaf.position.set(x,h+ls*0.4,z);scene.add(leaf);
  }
  var logM=new THREE.MeshBasicMaterial({color:0x5a4530});
  for(var i=0;i<8;i++){
    var log=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.4,3+Math.random()*3,5),logM);
    log.rotation.z=Math.PI/2;log.rotation.y=Math.random()*Math.PI;
    log.position.set((Math.random()-0.5)*25,0.3,-Math.random()*ZL);scene.add(log);
  }
  for(var i=0;i<4;i++)buildWreck((Math.random()>0.5?1:-1)*(8+Math.random()*15),-15-Math.random()*(ZL-30),true);
  for(var i=0;i<5;i++)addFire((Math.random()-0.5)*25,2,-10-Math.random()*(ZL-20));
  var gl=new THREE.PointLight(0xff3300,1.5,80);gl.position.set(0,6,-ZL*0.5);scene.add(gl);

  // SNOW
  var deadM=new THREE.MeshBasicMaterial({color:0x666655});
  for(var i=0;i<25;i++){
    var x=(Math.random()-0.5)*70,z=-ZL-Math.random()*ZL;
    if(Math.abs(x)<5)continue;
    var h=3+Math.random()*4;
    var dtm=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.25,h,5),deadM);dtm.position.set(x,h/2,z);scene.add(dtm);
  }
  var rkM=new THREE.MeshBasicMaterial({color:0x667788});
  for(var i=0;i<15;i++){
    var r=new THREE.Mesh(new THREE.DodecahedronGeometry(0.5+Math.random()*1.5,0),rkM);
    r.position.set((Math.random()-0.5)*55,Math.random()*0.5,-ZL-Math.random()*ZL);
    r.rotation.set(Math.random(),Math.random(),Math.random());scene.add(r);
  }
  for(var i=0;i<2;i++)buildWreck((Math.random()>0.5?1:-1)*(6+Math.random()*12),-ZL-20-Math.random()*(ZL-40),false);
  var sl=new THREE.PointLight(0x4488cc,0.4,60);sl.position.set(0,10,-ZL*1.5);scene.add(sl);

  // BUNKER ZONE
  var cM=new THREE.MeshBasicMaterial({color:0x777777});
  var dkM=new THREE.MeshBasicMaterial({color:0x555555});
  for(var i=0;i<18;i++){
    var b=new THREE.Mesh(new THREE.BoxGeometry(2+Math.random()*2,1.2,0.6),cM);
    b.position.set((Math.random()-0.5)*35,0.6,-ZL*2-Math.random()*(ZL-30));
    b.rotation.y=Math.random()*Math.PI;scene.add(b);
  }
  for(var i=0;i<4;i++){
    var w=4+Math.random()*6,h=3+Math.random()*5;
    var bld=new THREE.Mesh(new THREE.BoxGeometry(w,h,w),dkM);
    bld.position.set((Math.random()>0.5?1:-1)*(16+Math.random()*12),h/2,-ZL*2-Math.random()*ZL);
    scene.add(bld);
  }
  // BUNKER DOOR
  var door=new THREE.Mesh(new THREE.BoxGeometry(6,4,2),new THREE.MeshBasicMaterial({color:0x445566}));door.position.set(0,2,-TL+5);scene.add(door);
  var frame=new THREE.Mesh(new THREE.BoxGeometry(7,0.5,2.5),new THREE.MeshBasicMaterial({color:0x888800}));frame.position.set(0,4.25,-TL+5);scene.add(frame);
  var bsign=new THREE.Mesh(new THREE.BoxGeometry(3,0.4,0.1),new THREE.MeshBasicMaterial({color:0xffff00}));bsign.position.set(0,5,-TL+6.1);scene.add(bsign);
  var bl=new THREE.PointLight(0xffff44,1.2,30);bl.position.set(0,5,-TL+8);scene.add(bl);
  var wl=new THREE.PointLight(0xff0000,1.5,20);wl.position.set(3,4,-TL+8);scene.add(wl);
  fireLights.push({light:wl,type:'blink'});
  for(var i=0;i<6;i++)addFire((Math.random()-0.5)*25,2,-ZL*2-Math.random()*ZL);
  var al=new THREE.PointLight(0xff4400,0.7,40);al.position.set(0,5,-ZL*2.3);scene.add(al);

  // SNOW PARTICLES
  var cnt=1500,sg=new THREE.BufferGeometry(),sp=new Float32Array(cnt*3);
  for(var i=0;i<cnt;i++){sp[i*3]=(Math.random()-0.5)*80;sp[i*3+1]=Math.random()*25;sp[i*3+2]=-ZL-Math.random()*ZL}
  sg.setAttribute('position',new THREE.BufferAttribute(sp,3));
  snowPts=new THREE.Points(sg,new THREE.PointsMaterial({color:0xccccdd,size:0.15,transparent:true,opacity:0.6}));
  scene.add(snowPts);
}

function buildWreck(x,z,fire){
  var m=new THREE.MeshBasicMaterial({color:0x444450});
  var b=new THREE.Mesh(new THREE.BoxGeometry(2.5,1.2,4),m);
  b.position.set(x,0.6,z);b.rotation.y=Math.random()*Math.PI;b.rotation.z=(Math.random()-0.5)*0.3;scene.add(b);
  var t=new THREE.Mesh(new THREE.BoxGeometry(2,0.8,2.5),m);t.position.set(x,1.5,z);t.rotation.y=b.rotation.y;scene.add(t);
  if(fire)addFire(x,2,z);
}

function addFire(x,y,z){
  var fl=new THREE.PointLight(0xff4400,1.2+Math.random()*0.8,20);
  fl.position.set(x,y,z);scene.add(fl);
  fireLights.push({light:fl,type:'fire',base:0.8+Math.random()*0.6});
}

// SQUAD
function buildSquad(){
  var bG=new THREE.CylinderGeometry(0.25,0.3,1.2,6);
  var hG=new THREE.SphereGeometry(0.2,6,5);
  var lG=new THREE.CylinderGeometry(0.08,0.1,0.6,4);
  var gG=new THREE.BoxGeometry(0.08,0.08,0.6);
  var skM=new THREE.MeshBasicMaterial({color:0xcc9966});
  var gnM=new THREE.MeshBasicMaterial({color:0x333333});
  for(var i=0;i<squad.length;i++){
    var s=squad[i],gr=new THREE.Group();
    var bM=new THREE.MeshBasicMaterial({color:s.color});
    var body=new THREE.Mesh(bG.clone(),bM);body.position.y=1.2;gr.add(body);
    var head=new THREE.Mesh(hG.clone(),skM);head.position.y=2;gr.add(head);
    var ll=new THREE.Mesh(lG.clone(),bM);ll.position.set(-0.12,0.3,0);gr.add(ll);
    var rl=new THREE.Mesh(lG.clone(),bM);rl.position.set(0.12,0.3,0);gr.add(rl);
    var gun=new THREE.Mesh(gG.clone(),gnM);gun.position.set(0.3,1.2,-0.2);gr.add(gun);
    var ang=(i/squad.length)*Math.PI*0.6-Math.PI*0.3;
    var dist=2.5+Math.random()*0.5;
    gr.position.set(Math.sin(ang)*dist,0,Math.cos(ang)*dist-1);
    gr.userData={idx:i,ft:Math.random()*2,bp:Math.random()*6.28};
    scene.add(gr);squadMeshes.push(gr);
  }
}

// ENEMIES
function mkEnemy(type,x,y,z){
  var gr=new THREE.Group();
  var mM=new THREE.MeshBasicMaterial({color:0x666677});
  var dM=new THREE.MeshBasicMaterial({color:0x444455});
  var eM=new THREE.MeshBasicMaterial({color:0xff0000});
  var hp,spd,dmg,ar,sz;
  if(type==='stumper'){
    hp=30;spd=5.5+Math.random()*2;dmg=10;ar=2.5;sz=0.7;
    var bd=new THREE.Mesh(new THREE.SphereGeometry(0.4,6,4),mM);bd.position.y=0.5;gr.add(bd);
    for(var l=0;l<6;l++){
      var leg=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.04,0.6,3),dM);
      var a=(l/6)*Math.PI*2;leg.position.set(Math.cos(a)*0.35,0.2,Math.sin(a)*0.35);
      leg.rotation.z=Math.cos(a)*0.8;gr.add(leg);
    }
    var e1=new THREE.Mesh(new THREE.SphereGeometry(0.06,4,3),eM);e1.position.set(0.12,0.6,-0.3);gr.add(e1);
    var e2=new THREE.Mesh(new THREE.SphereGeometry(0.06,4,3),eM);e2.position.set(-0.12,0.6,-0.3);gr.add(e2);
  }else if(type==='drone'){
    hp=25;spd=7+Math.random()*3;dmg=12;ar=22;sz=0.8;
    gr.add(new THREE.Mesh(new THREE.SphereGeometry(0.3,6,4),mM));
    for(var r=0;r<4;r++){
      var rt=new THREE.Mesh(new THREE.BoxGeometry(0.7,0.02,0.1),dM);
      var a=(r/4)*Math.PI*2;rt.position.set(Math.cos(a)*0.35,0.15,Math.sin(a)*0.35);
      rt.rotation.y=a;gr.add(rt);
    }
    var ey=new THREE.Mesh(new THREE.SphereGeometry(0.07,4,3),eM);ey.position.set(0,-0.1,-0.25);gr.add(ey);
    y=3+Math.random()*3;
  }else{
    hp=100;spd=2.5+Math.random();dmg=22;ar=16;sz=2;
    var to=new THREE.Mesh(new THREE.BoxGeometry(1,1.5,0.8),mM);to.position.y=2;gr.add(to);
    var hd=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5),dM);hd.position.y=3;gr.add(hd);
    var al=new THREE.Mesh(new THREE.BoxGeometry(0.3,1.2,0.3),mM);al.position.set(-0.8,1.8,0);gr.add(al);
    var ar2=new THREE.Mesh(new THREE.BoxGeometry(0.3,1.2,0.3),mM);ar2.position.set(0.8,1.8,0);gr.add(ar2);
    var ll=new THREE.Mesh(new THREE.BoxGeometry(0.35,1.3,0.35),dM);ll.position.set(-0.3,0.65,0);gr.add(ll);
    var lr=new THREE.Mesh(new THREE.BoxGeometry(0.35,1.3,0.35),dM);lr.position.set(0.3,0.65,0);gr.add(lr);
    var vi=new THREE.Mesh(new THREE.BoxGeometry(0.4,0.1,0.05),eM);vi.position.set(0,3.1,-0.28);gr.add(vi);
  }
  gr.position.set(x,y,z);
  gr.userData={type:type,hp:hp,maxHp:hp,spd:spd,dmg:dmg,ar:ar,sz:sz,alive:true,ft:1+Math.random()*2,onFire:false,fireT:0,stag:0};
  scene.add(gr);enemies.push(gr);
}

function spawnEn(dt){
  spawnTmr-=dt;if(spawnTmr>0||enemies.length>=MAX_EN)return;
  var prog=Math.min(1,-playerPos.z/TL),diff=1+prog*2.5;
  spawnTmr=2.5/diff;
  var cnt=Math.min(3,1+Math.floor(Math.random()*diff));
  for(var i=0;i<cnt;i++){
    var side=(Math.random()-0.5)*50;
    var z=Math.random()>0.3?(playerPos.z-25-Math.random()*30):(playerPos.z+12+Math.random()*15);
    var roll=Math.random(),type;
    if(curZone===0)type=roll<0.5?'stumper':roll<0.85?'drone':'heavy';
    else if(curZone===1)type=roll<0.3?'stumper':roll<0.6?'drone':'heavy';
    else type=roll<0.2?'stumper':roll<0.45?'drone':'heavy';
    mkEnemy(type,side,0,z);
    if(Math.random()<0.25)shout(type==='drone'?'drone':type==='stumper'?'stumper':'heavy');
  }
}

// PARTICLES
function mkParts(pos,cnt,col,spd,life,sz){
  for(var i=0;i<cnt;i++){
    var m=new THREE.Mesh(new THREE.SphereGeometry(sz||0.05,3,2),new THREE.MeshBasicMaterial({color:col||0xff4400,transparent:true,opacity:1}));
    m.position.copy(pos);
    m.userData={vel:new THREE.Vector3((Math.random()-0.5)*spd,Math.random()*spd*0.7+1,(Math.random()-0.5)*spd),life:life||1,ml:life||1,flame:false,debris:false};
    scene.add(m);particles.push(m);
  }
}

function mkDebris(pos,cnt){
  for(var i=0;i<cnt;i++){
    var s=0.05+Math.random()*0.15;
    var m=new THREE.Mesh(new THREE.BoxGeometry(s,s,s*2),new THREE.MeshBasicMaterial({color:0x555566}));
    m.position.copy(pos);m.position.y+=Math.random()*0.5;
    m.userData={vel:new THREE.Vector3((Math.random()-0.5)*8,3+Math.random()*5,(Math.random()-0.5)*8),life:2.5,ml:2.5,debris:true,flame:false};
    scene.add(m);particles.push(m);
  }
}

function explode(pos){
  mkParts(pos,12,0xff4400,5,0.8,0.1);
  mkParts(pos,8,0xff8800,4,0.6,0.12);
  mkParts(pos,6,0xffcc00,3,0.5,0.07);
  mkParts(pos,5,0x111111,4,1.2,0.08);
  mkDebris(pos,6);
  var lt=new THREE.PointLight(0xff4400,3,15);lt.position.copy(pos);scene.add(lt);
  setTimeout(function(){scene.remove(lt)},250);
  snd('explosion',0.3);
}

function mkFlame(origin,dir){
  var cols=[0xff2200,0xff4400,0xff8800,0xffaa00];
  for(var i=0;i<3;i++){
    var m=new THREE.Mesh(new THREE.SphereGeometry(0.08+Math.random()*0.08,4,3),
      new THREE.MeshBasicMaterial({color:cols[Math.floor(Math.random()*cols.length)],transparent:true,opacity:0.85}));
    m.position.copy(origin);
    var v=dir.clone().multiplyScalar(12+Math.random()*5);
    v.x+=(Math.random()-0.5)*2;v.y+=(Math.random()-0.5)*1.5;v.z+=(Math.random()-0.5)*2;
    m.userData={vel:v,life:0.35+Math.random()*0.2,ml:0.5,flame:true,debris:false};
    scene.add(m);particles.push(m);
  }
}

// COMBAT
function fire(){
  var w=weapons[curWeap],now=clock.getElapsedTime();
  if(now-lastFire<w.fireRate||w.ammo<=0||isReloading)return;
  lastFire=now;w.ammo--;updAmmo();snd(w.snd,0.18);

  if(curWeap==='flamethrower'){
    var dir=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
    var org=camera.position.clone().add(dir.clone().multiplyScalar(0.5));org.y-=0.2;
    mkFlame(org,dir);
    for(var i=0;i<enemies.length;i++){
      var e=enemies[i];if(!e.userData.alive)continue;
      var d=e.position.distanceTo(camera.position);if(d>w.range)continue;
      var toE=e.position.clone().sub(camera.position).normalize();
      if(dir.dot(toE)>0.85){dmgEnemy(e,w.damage);e.userData.onFire=true;e.userData.fireT=2.5}
    }
  }else{
    var fl=new THREE.PointLight(0xffaa44,2,8);
    fl.position.copy(camera.position);
    fl.position.add(new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion));
    scene.add(fl);setTimeout(function(){scene.remove(fl)},40);
    pitch+=(Math.random()-0.4)*0.012;
    var pellets=w.pellets||1;
    for(var p=0;p<pellets;p++){
      var dir=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
      dir.x+=(Math.random()-0.5)*w.spread;dir.y+=(Math.random()-0.5)*w.spread;dir.normalize();
      var best=null,bestD=999;
      for(var i=0;i<enemies.length;i++){
        var e=enemies[i];if(!e.userData.alive)continue;
        var toE=e.position.clone().sub(camera.position);var d=toE.length();toE.normalize();
        var dot=dir.dot(toE);
        var thr=Math.max(0.92,1-e.userData.sz*0.5/Math.max(d,1));
        if(dot>thr&&d<bestD&&d<80){best=e;bestD=d}
      }
      if(best){
        dmgEnemy(best,w.damage);
        mkParts(best.position.clone().add(new THREE.Vector3(0,0.8,0)),3,0xffaa00,4,0.3,0.03);
        snd('hit',0.12);
      }
      var te=best?best.position.clone():camera.position.clone().add(dir.clone().multiplyScalar(60));
      var tg=new THREE.BufferGeometry().setFromPoints([camera.position.clone().add(dir.clone().multiplyScalar(0.8)),te]);
      var tr=new THREE.Line(tg,new THREE.LineBasicMaterial({color:0xffaa44,transparent:true,opacity:0.4}));
      scene.add(tr);(function(t){setTimeout(function(){scene.remove(t)},50)})(tr);
    }
  }
  if(w.ammo<=0&&w.reserve>0)startReload();
}

function dmgEnemy(en,dmg){
  var u=en.userData;u.hp-=dmg;u.stag=0.12;
  if(u.hp<=0&&u.alive){
    u.alive=false;kills++;
    document.getElementById('kill-count').textContent='KILLS: '+kills;
    explode(en.position.clone().add(new THREE.Vector3(0,0.8,0)));
    snd('robot_die',0.25);
    var ref=en;setTimeout(function(){scene.remove(ref);var idx=enemies.indexOf(ref);if(idx>-1)enemies.splice(idx,1)},150);
  }
}

function dmgPlayer(dmg){
  playerHealth-=dmg;if(playerHealth<0)playerHealth=0;
  document.getElementById('health-text').textContent=Math.round(playerHealth);
  document.getElementById('health-fill').style.width=playerHealth+'%';
  if(playerHealth<30)document.getElementById('health-fill').style.background='#ff0000';
  else if(playerHealth<60)document.getElementById('health-fill').style.background='#ff6600';
  else document.getElementById('health-fill').style.background='#ff2200';
  document.getElementById('damage-overlay').style.opacity='0.5';
  setTimeout(function(){document.getElementById('damage-overlay').style.opacity='0'},180);
  pitch+=(Math.random()-0.5)*0.04;yaw+=(Math.random()-0.5)*0.02;
  snd('damage',0.2);
  if(playerHealth<=0)dieGame();
}

function startReload(){
  if(isReloading)return;var w=weapons[curWeap];
  if(w.ammo>=w.maxAmmo||w.reserve<=0)return;
  isReloading=true;reloadTimer=1.4;
  document.getElementById('weapon-name').textContent='RELOADING...';
}

function finishReload(){
  var w=weapons[curWeap];var need=w.maxAmmo-w.ammo;var av=Math.min(need,w.reserve);
  w.ammo+=av;w.reserve-=av;isReloading=false;updAmmo();
}

// MAIN LOOP
function animate(){
  requestAnimationFrame(animate);
  if(!gameActive)return;
  var dt=Math.min(clock.getDelta(),0.05);
  var time=clock.getElapsedTime();

  // PLAYER
  if(locked){
    camera.quaternion.setFromEuler(new THREE.Euler(pitch,yaw,0,'YXZ'));
    var spd=keys['ShiftLeft']?8:5;
    var mv=new THREE.Vector3();
    if(keys['KeyW'])mv.z-=1;if(keys['KeyS'])mv.z+=1;
    if(keys['KeyA'])mv.x-=1;if(keys['KeyD'])mv.x+=1;
    if(mv.lengthSq()>0){
      mv.normalize();mv.applyQuaternion(new THREE.Quaternion().setFromEuler(new THREE.Euler(0,yaw,0)));
      playerPos.add(mv.multiplyScalar(spd*dt));
    }
    playerPos.x=Math.max(-35,Math.min(35,playerPos.x));
    playerPos.z=Math.max(-TL+3,Math.min(5,playerPos.z));
    playerPos.y=1.7;
    camera.position.copy(playerPos);
    if(mouseDown&&weapons[curWeap].auto)fire();
    if(mouseDown&&!weapons[curWeap].auto){fire();mouseDown=false}
    document.getElementById('zone-progress').textContent='PROGRESS: '+Math.min(100,Math.round(-playerPos.z/TL*100))+'%';
    if(playerPos.z<=-TL+10)winGame();
  }

  if(isReloading){reloadTimer-=dt;if(reloadTimer<=0)finishReload()}

  // SQUAD
  for(var i=0;i<squadMeshes.length;i++){
    var m=squadMeshes[i],s=squad[i];
    if(!s.alive){m.visible=false;continue}
    m.visible=true;
    var ang=(i/squad.length)*Math.PI*0.8-Math.PI*0.4;
    var dist=3+Math.sin(time*0.5+i)*0.5;
    var tx=playerPos.x+Math.sin(yaw+ang)*dist;
    var tz=playerPos.z+Math.cos(yaw+ang)*dist;
    m.position.x+=(tx-m.position.x)*2.5*dt;
    m.position.z+=(tz-m.position.z)*2.5*dt;
    m.position.y=0;
    var nE=null,nD=999;
    for(var j=0;j<enemies.length;j++){
      if(!enemies[j].userData.alive)continue;
      var d=enemies[j].position.distanceTo(m.position);if(d<nD){nD=d;nE=enemies[j]}
    }
    if(nE){
      m.lookAt(nE.position.x,0,nE.position.z);
      m.userData.ft-=dt;
      if(m.userData.ft<=0&&nD<25){
        m.userData.ft=s.fr+Math.random()*0.15;
        dmgEnemy(nE,s.dmg*0.5);
        mkParts(m.position.clone().add(new THREE.Vector3(0,1.2,0)),1,0xffaa00,3,0.15,0.02);
        snd('rifle',0.04);
      }
    }
    for(var j=0;j<enemies.length;j++){
      var e=enemies[j];if(!e.userData.alive)continue;
      var d=e.position.distanceTo(m.position);
      if(d<e.userData.ar*1.2&&Math.random()<0.012){
        s.hp-=e.userData.dmg*0.25;
        if(s.hp<=0&&s.alive){s.alive=false;shout('down');updSquadHUD();mkParts(m.position.clone().add(new THREE.Vector3(0,1,0)),8,0xff0000,3,1,0.05)}
      }
    }
  }

  // ENEMIES
  for(var i=enemies.length-1;i>=0;i--){
    var e=enemies[i],u=e.userData;if(!u.alive)continue;
    var toP=new THREE.Vector3().subVectors(playerPos,e.position);var dP=toP.length();toP.normalize();
    if(u.stag>0){u.stag-=dt;e.position.add(toP.clone().multiplyScalar(-2*dt))}
    else{
      if(u.type==='drone'){
        var str=Math.sin(time*2+i*1.7)*4;var sD=new THREE.Vector3(-toP.z,0,toP.x);
        e.position.add(toP.clone().multiplyScalar(u.spd*dt*0.4));
        e.position.add(sD.multiplyScalar(str*dt));
        e.position.y=3+Math.sin(time*1.5+i)*1.2;
      }else if(u.type==='stumper'){
        e.position.add(toP.clone().multiplyScalar(u.spd*dt));e.position.y=0;
        e.rotation.z=Math.sin(time*12+i)*0.2;
      }else{
        e.position.add(toP.clone().multiplyScalar(u.spd*dt));e.position.y=0;
      }
    }
    e.lookAt(playerPos.x,e.position.y,playerPos.z);
    if(u.onFire){
      u.fireT-=dt;u.hp-=4*dt;
      if(Math.random()<0.25)mkParts(e.position.clone().add(new THREE.Vector3(0,0.8,0)),1,0xff4400,2,0.25,0.05);
      if(u.fireT<=0)u.onFire=false;
      if(u.hp<=0&&u.alive){u.alive=false;kills++;document.getElementById('kill-count').textContent='KILLS: '+kills;explode(e.position.clone());snd('robot_die',0.25);(function(ref){setTimeout(function(){scene.remove(ref);var idx=enemies.indexOf(ref);if(idx>-1)enemies.splice(idx,1)},150)})(e)}
    }
    u.ft-=dt;
    if(u.type==='stumper'&&dP<u.ar){if(u.ft<=0){u.ft=0.8;dmgPlayer(u.dmg)}}
    else if((u.type==='drone'||u.type==='heavy')&&dP<u.ar){
      if(u.ft<=0){
        u.ft=u.type==='drone'?1.8:2.2;
        if(Math.random()<0.45)dmgPlayer(u.dmg*0.6);
        var tg=new THREE.BufferGeometry().setFromPoints([e.position.clone().add(new THREE.Vector3(0,0.5,0)),playerPos.clone()]);
        var tr=new THREE.Line(tg,new THREE.LineBasicMaterial({color:0xff0000,transparent:true,opacity:0.4}));
        scene.add(tr);(function(t){setTimeout(function(){scene.remove(t)},80)})(tr);
      }
    }
    if(dP>80){scene.remove(e);enemies.splice(i,1)}
  }

  // PARTICLES
  for(var i=particles.length-1;i>=0;i--){
    var p=particles[i],pu=p.userData;pu.life-=dt;
    if(pu.life<=0){scene.remove(p);particles.splice(i,1);continue}
    p.position.x+=pu.vel.x*dt;p.position.y+=pu.vel.y*dt;p.position.z+=pu.vel.z*dt;
    if(pu.debris){pu.vel.y-=12*dt;if(p.position.y<0.05){p.position.y=0.05;pu.vel.y*=-0.3;pu.vel.x*=0.7;pu.vel.z*=0.7}p.rotation.x+=dt*5;p.rotation.z+=dt*3}
    else pu.vel.y-=3*dt;
    p.material.opacity=pu.life/pu.ml;
    if(pu.flame)p.scale.setScalar(1+(1-pu.life/pu.ml)*2.5);
  }

  // FIRES
  for(var i=0;i<fireLights.length;i++){
    var f=fireLights[i];
    if(f.type==='fire')f.light.intensity=f.base+Math.sin(time*5+i*2)*0.3;
    else if(f.type==='blink')f.light.intensity=Math.sin(time*3)>0?1.5:0.2;
  }

  // SNOW
  if(snowPts){
    var sp=snowPts.geometry.attributes.position.array;
    for(var i=0;i<sp.length;i+=3){sp[i]+=Math.sin(time+i*0.01)*0.008;sp[i+1]-=dt*1.8;if(sp[i+1]<0){sp[i+1]=22;sp[i]=(Math.random()-0.5)*80}}
    snowPts.geometry.attributes.position.needsUpdate=true;
  }

  // ZONES
  var z=-playerPos.z;var nz=z<ZL?0:z<ZL*2?1:2;
  if(nz!==curZone){
    curZone=nz;
    if(nz===1){zoneText('THE SNOWFIELDS');scene.fog=new THREE.FogExp2(0x334455,0.005);scene.background=new THREE.Color(0x334455);shout('zone1')}
    else if(nz===2){zoneText('BUNKER 7 APPROACH');scene.fog=new THREE.FogExp2(0x111118,0.007);scene.background=new THREE.Color(0x111118);shout('zone2')}
  }

  spawnEn(dt);
  if(callTmr>0)callTmr-=dt;
  if(Math.random()<0.0015&&callTmr<=0)shout('general');

  renderer.render(scene,camera);
}

function winGame(){
  if(gameWon)return;gameWon=true;gameActive=false;
  try{document.exitPointerLock()}catch(e){}
  var surv=squad.filter(function(s){return s.alive});
  var msg=surv.length>0?
    'You and '+surv.map(function(s){return s.name}).join(', ')+' made it inside. '+(4-surv.length)+' didn\'t. Kills: '+kills:
    'You made it alone. The whole squad is gone. Kills: '+kills;
  document.getElementById('victory-msg').textContent=msg;
  document.getElementById('victory-screen').style.display='flex';
  document.getElementById('hud').style.display='none';
}

function dieGame(){
  gameActive=false;try{document.exitPointerLock()}catch(e){}
  document.getElementById('death-screen').style.display='flex';
  document.getElementById('hud').style.display='none';
}

// START
document.getElementById('startBtn').addEventListener('click',function(e){
  e.stopPropagation();
  document.getElementById('blocker').style.display='none';
  if(!initialized){init()}
  else{renderer.domElement.requestPointerLock()}
});
document.getElementById('blocker').addEventListener('click',function(e){
  if(e.target.id==='startBtn')return;
  if(gameActive&&renderer){
    document.getElementById('blocker').style.display='none';
    renderer.domElement.requestPointerLock();
  }
});

})();
</script>
</body>
</html>
